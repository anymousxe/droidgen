<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroidGen</title>
    <link rel="icon" type="image/png" href="/droidgenicon.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="DroidGen">
    <meta name="twitter:description" content="DroidGen is an AI site made by AnymousXE and Singus, developed with Nickname.">
    <meta property="og:title" content="DroidGen">
    <meta property="og:description" content="DroidGen is an AI site made by AnymousXE and Singus, developed with Nickname.">
    <meta property="og:type" content="website">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="app">
        <div id="auth-screen" class="screen active">
            <div class="auth-container">
                <div class="auth-card">
                    <div class="auth-logo">
                        <img src="/droidgenicon.png" alt="DroidGen" class="logo-img">
                        <h1>DroidGen</h1>
                    </div>
                    <p class="auth-subtitle">AI-Powered Code Generation</p>
                    <button id="google-login" class="btn-primary btn-google">
                        <i class="fab fa-google"></i>
                        <span>Continue with Google</span>
                    </button>
                    <div class="demo-badge">
                        <i class="fas fa-gift"></i>
                        <span>Demo: 100K free credits!</span>
                    </div>
                </div>
            <div class="auth-bg">
                <div class="bg-gradient"></div>
            </div>
        </div>

        <div id="main-screen" class="screen">
            <nav class="navbar">
                <div class="nav-brand">
                    <img src="/droidgenicon.png" alt="DroidGen" class="nav-logo">
                    <span class="nav-title">DroidGen</span>
                </div>
                <div class="nav-search" id="nav-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Search projects...">
                </div>
                <div class="nav-actions">
                    <div class="credits-badge">
                        <i class="fas fa-coins"></i>
                        <span id="credits-count">0</span>
                    </div>
                    <button id="create-project-btn" class="btn-primary btn-create">
                        <i class="fas fa-plus"></i>
                        <span>Create</span>
                    </button>
                    <div class="user-menu" id="user-menu">
                        <div id="user-avatar" class="avatar"></div>
                        <div class="user-dropdown" id="user-dropdown">
                            <div class="dropdown-header">
                                <div class="dropdown-avatar"></div>
                                <div class="dropdown-info">
                                    <span id="dropdown-name"></span>
                                    <span id="dropdown-email"></span>
                                </div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" id="my-projects-btn">
                                <i class="fas fa-folder"></i>
                                <span>My Projects</span>
                            </button>
                            <button class="dropdown-item" id="settings-btn">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item danger" id="logout-btn">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="main-layout">
                <aside class="sidebar" id="sidebar">
                    <div class="sidebar-section">
                        <button class="sidebar-item active" data-view="feed">
                            <i class="fas fa-home"></i>
                            <span>Feed</span>
                        </button>
                        <button class="sidebar-item" data-view="my-projects">
                            <i class="fas fa-folder"></i>
                            <span>My Projects</span>
                        </button>
                        <button class="sidebar-item" data-view="explore">
                            <i class="fas fa-compass"></i>
                            <span>Explore</span>
                        </button>
                    </div>
                    <div class="sidebar-divider"></div>
                    <div class="sidebar-section">
                        <div class="sidebar-label">Models</div>
                        <div class="model-list">
                            <div class="model-item">
                                <span class="model-name">MiMo 2 Flash</span>
                                <span class="model-cost">300</span>
                            </div>
                            <div class="model-item">
                                <span class="model-name">Devstral 2</span>
                                <span class="model-cost">100</span>
                            </div>
                            <div class="model-item">
                                <span class="model-name">GLM 4.5 Air</span>
                                <span class="model-cost">100</span>
                            </div>
                            <div class="model-item">
                                <span class="model-name">GPT OSS</span>
                                <span class="model-cost">50</span>
                            </div>
                            <div class="model-item coming-soon">
                                <span class="model-name">Momentum Max</span>
                                <span class="model-badge">Coming Soon</span>
                            </div>
                        </div>
                    </div>
                </aside>

                <main class="content" id="content">
                    <div id="feed-view" class="view active">
                        <div class="feed-header">
                            <h2>Discover Projects</h2>
                            <p>Explore what the community is building</p>
                        </div>
                        <div id="feed-grid" class="project-grid">
                            <div class="empty-feed">
                                <i class="fas fa-rocket"></i>
                                <h3>No projects yet</h3>
                                <p>Be the first to create something amazing!</p>
                                <button class="btn-primary" id="empty-create-btn">
                                    <i class="fas fa-plus"></i>
                                    Create Project
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="my-projects-view" class="view">
                        <div class="feed-header">
                            <h2>My Projects</h2>
                            <p>Manage your creations</p>
                        </div>
                        <div id="my-projects-grid" class="project-grid"></div>
                    </div>

                    <div id="explore-view" class="view">
                        <div class="feed-header">
                            <h2>Explore</h2>
                            <p>Find inspiration from trending projects</p>
                        </div>
                        <div id="explore-grid" class="project-grid"></div>
                    </div>

                    <div id="editor-view" class="view">
                        <div class="editor-layout">
                            <div class="editor-sidebar">
                                <div class="editor-sidebar-header">
                                    <button id="back-to-feed" class="btn-icon">
                                        <i class="fas fa-arrow-left"></i>
                                    </button>
                                    <span class="project-title" id="editor-project-title">Untitled</span>
                                    <button id="project-settings-btn" class="btn-icon">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                                <div class="file-tree" id="file-tree">
                                    <div class="file-tree-header">
                                        <span>Files</span>
                                        <button id="add-file-btn" class="btn-icon-sm">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="file-list" id="file-list"></div>
                                </div>
                                <div class="version-history">
                                    <div class="version-header">
                                        <span>Versions</span>
                                    </div>
                                    <div class="version-list" id="version-list"></div>
                                </div>
                            </div>
                            <div class="editor-main">
                                <div class="editor-tabs" id="editor-tabs"></div>
                                <div class="editor-content">
                                    <div class="code-editor" id="code-editor">
                                        <textarea id="code-textarea" spellcheck="false"></textarea>
                                    </div>
                                    <div class="preview-panel" id="preview-panel">
                                        <div class="preview-header">
                                            <span>Preview</span>
                                            <button id="refresh-preview" class="btn-icon-sm">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
                                    </div>
                                </div>
                                <div class="prompt-bar" id="prompt-bar">
                                    <div class="prompt-model">
                                        <button id="model-selector" class="model-selector-btn">
                                            <span id="current-model">MiMo 2 Flash</span>
                                            <i class="fas fa-chevron-up"></i>
                                        </button>
                                        <div class="model-dropdown" id="model-dropdown">
                                            <button class="model-option active" data-model="xiaomi/mimo-v2-flash:free" data-cost="300">
                                                <div class="model-option-info">
                                                    <span class="name">MiMo 2 Flash</span>
                                                    <span class="desc">Fast and efficient</span>
                                                </div>
                                                <span class="cost">300 credits</span>
                                            </button>
                                            <button class="model-option" data-model="mistralai/devstral-2512:free" data-cost="100">
                                                <div class="model-option-info">
                                                    <span class="name">Devstral 2</span>
                                                    <span class="desc">Code specialist</span>
                                                </div>
                                                <span class="cost">100 credits</span>
                                            </button>
                                            <button class="model-option" data-model="z-ai/glm-4.5-air:free" data-cost="100">
                                                <div class="model-option-info">
                                                    <span class="name">GLM 4.5 Air</span>
                                                    <span class="desc">Balanced performance</span>
                                                </div>
                                                <span class="cost">100 credits</span>
                                            </button>
                                            <button class="model-option" data-model="openai/gpt-oss-120b:free" data-cost="50">
                                                <div class="model-option-info">
                                                    <span class="name">GPT OSS</span>
                                                    <span class="desc">Budget friendly</span>
                                                </div>
                                                <span class="cost">50 credits</span>
                                            </button>
                                            <div class="model-option disabled">
                                                <div class="model-option-info">
                                                    <span class="name">Momentum Max</span>
                                                    <span class="desc">Premium model</span>
                                                </div>
                                                <span class="badge-soon">Coming Soon</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="prompt-input-wrapper">
                                        <textarea id="prompt-input" placeholder="Describe what you want to build or change..." rows="1"></textarea>
                                    </div>
                                    <button id="generate-btn" class="btn-generate" disabled>
                                        <i class="fas fa-bolt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="editor-right-panel">
                                <div class="panel-tabs">
                                    <button class="panel-tab active" data-panel="comments">
                                        <i class="fas fa-comments"></i>
                                        <span>Comments</span>
                                    </button>
                                    <button class="panel-tab" data-panel="ai-chat">
                                        <i class="fas fa-robot"></i>
                                        <span>AI Chat</span>
                                    </button>
                                </div>
                                <div class="panel-content">
                                    <div id="comments-panel" class="panel active">
                                        <div class="comments-list" id="comments-list"></div>
                                        <div class="comment-input">
                                            <textarea id="comment-input" placeholder="Add a comment..."></textarea>
                                            <button id="post-comment" class="btn-sm">Post</button>
                                        </div>
                                    </div>
                                    <div id="ai-chat-panel" class="panel">
                                        <div class="chat-messages" id="chat-messages"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="create-modal" class="modal">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Project</h2>
                    <button class="modal-close"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" id="new-project-name" placeholder="My Awesome Project">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="new-project-desc" placeholder="What are you building?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Visibility</label>
                        <div class="visibility-options">
                            <label class="visibility-option">
                                <input type="radio" name="visibility" value="public" checked>
                                <div class="option-content">
                                    <i class="fas fa-globe"></i>
                                    <div>
                                        <span class="option-title">Public</span>
                                        <span class="option-desc">Visible on feed</span>
                                    </div>
                                </div>
                            </label>
                            <label class="visibility-option">
                                <input type="radio" name="visibility" value="unlisted">
                                <div class="option-content">
                                    <i class="fas fa-link"></i>
                                    <div>
                                        <span class="option-title">Unlisted</span>
                                        <span class="option-desc">Anyone with link</span>
                                    </div>
                                </div>
                            </label>
                            <label class="visibility-option">
                                <input type="radio" name="visibility" value="private">
                                <div class="option-content">
                                    <i class="fas fa-lock"></i>
                                    <div>
                                        <span class="option-title">Private</span>
                                        <span class="option-desc">Only you</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary modal-cancel">Cancel</button>
                    <button class="btn-primary" id="create-project-submit">
                        <i class="fas fa-plus"></i>
                        Create Project
                    </button>
                </div>
            </div>
        </div>

        <div id="project-settings-modal" class="modal">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Project Settings</h2>
                    <button class="modal-close"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="project-display-name">
                    </div>
                    <div class="form-group">
                        <label>URL Slug</label>
                        <div class="input-prefix">
                            <span>@<span id="username-preview">user</span>/</span>
                            <input type="text" id="project-slug" placeholder="my-project">
                        </div>
                        <small>Leave empty for auto-generated ID</small>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="project-description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Visibility</label>
                        <select id="project-visibility">
                            <option value="public">Public</option>
                            <option value="unlisted">Unlisted</option>
                            <option value="private">Private</option>
                        </select>
                    </div>
                    <div class="form-group danger-zone">
                        <label>Danger Zone</label>
                        <button class="btn-danger" id="delete-project-btn">
                            <i class="fas fa-trash"></i>
                            Delete Project
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary modal-cancel">Cancel</button>
                    <button class="btn-primary" id="save-project-settings">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="modal">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button class="modal-close"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="settings-section">
                        <h3>Profile</h3>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="settings-username" placeholder="username">
                            <small>Used in project URLs: @username/project</small>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3>Account</h3>
                        <div class="account-info">
                            <div class="info-row">
                                <span>Email</span>
                                <span id="settings-email-display"></span>
                            </div>
                            <div class="info-row">
                                <span>Credits</span>
                                <span id="settings-credits-display"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary modal-cancel">Cancel</button>
                    <button class="btn-primary" id="save-settings">Save</button>
                </div>
            </div>
        </div>

        <div id="add-file-modal" class="modal">
            <div class="modal-backdrop"></div>
            <div class="modal-content modal-sm">
                <div class="modal-header">
                    <h2>Add File</h2>
                    <button class="modal-close"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Filename</label>
                        <input type="text" id="new-filename" placeholder="script.js">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary modal-cancel">Cancel</button>
                    <button class="btn-primary" id="add-file-submit">Add File</button>
                </div>
            </div>
        </div>

        <div id="toast-container"></div>
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <span>Generating...</span>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="app.js"></script>
  <script src="/api/generate.js"></script>
</body>
</html>

/* style.css */
:root {
    --bg-0: #09090b;
    --bg-1: #0f0f12;
    --bg-2: #16161a;
    --bg-3: #1e1e24;
    --bg-4: #27272f;
    --border: #2e2e38;
    --border-light: #3e3e4a;
    --text: #fafafa;
    --text-2: #a1a1aa;
    --text-3: #71717a;
    --accent: #10b981;
    --accent-hover: #059669;
    --accent-soft: rgba(16, 185, 129, 0.15);
    --danger: #ef4444;
    --warning: #f59e0b;
    --radius: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --transition: 0.15s ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; }

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-0);
    color: var(--text);
    line-height: 1.5;
    overflow: hidden;
}

#app { height: 100%; }

.screen {
    position: fixed;
    inset: 0;
    display: none;
}

.screen.active { display: flex; }

#auth-screen {
    align-items: center;
    justify-content: center;
    background: var(--bg-0);
}

.auth-bg {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
}

.bg-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(100px);
    opacity: 0.4;
}

.bg-orb-1 {
    width: 500px;
    height: 500px;
    background: var(--accent);
    top: -150px;
    right: -100px;
    animation: float1 20s ease-in-out infinite;
}

.bg-orb-2 {
    width: 400px;
    height: 400px;
    background: #06b6d4;
    bottom: -100px;
    left: -100px;
    animation: float2 25s ease-in-out infinite;
}

.bg-orb-3 {
    width: 300px;
    height: 300px;
    background: #8b5cf6;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: float3 18s ease-in-out infinite;
}

@keyframes float1 {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(-50px, 50px); }
}

@keyframes float2 {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(50px, -30px); }
}

@keyframes float3 {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.2); }
}

.auth-card {
    position: relative;
    z-index: 10;
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    padding: 48px;
    text-align: center;
    width: 100%;
    max-width: 400px;
    margin: 20px;
    box-shadow: var(--shadow);
}

.auth-logo { margin-bottom: 8px; }

.logo-img {
    width: 72px;
    height: 72px;
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
}

.auth-logo h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
}

.auth-subtitle {
    color: var(--text-2);
    margin-bottom: 32px;
    font-size: 15px;
}

.btn-google {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    padding: 14px 24px;
    background: #fff;
    color: #333;
    border: none;
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.btn-google:hover {
    background: #f5f5f5;
    transform: translateY(-1px);
}

.btn-google:active {
    transform: scale(0.98);
}

.demo-badge {
    margin-top: 24px;
    padding: 12px 16px;
    background: var(--accent-soft);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: var(--radius);
    color: var(--accent);
    font-size: 13px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

#main-screen { flex-direction: column; }

.navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
    padding: 0 24px;
    height: 60px;
    background: var(--bg-1);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}

.nav-brand {
    display: flex;
    align-items: center;
    gap: 12px;
}

.nav-logo {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    transition: transform 0.3s ease;
}

.nav-logo.spinning {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.nav-title {
    font-size: 18px;
    font-weight: 700;
}

.nav-search {
    flex: 1;
    max-width: 400px;
    position: relative;
}

.nav-search i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-3);
    font-size: 13px;
}

.nav-search input {
    width: 100%;
    padding: 10px 16px 10px 40px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: var(--transition);
}

.nav-search input:focus {
    border-color: var(--accent);
    background: var(--bg-3);
}

.nav-search input::placeholder { color: var(--text-3); }

.nav-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.credits-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
}

.credits-badge i { color: var(--warning); }

.btn-create {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.btn-create:hover {
    background: var(--accent-hover);
}

.btn-create:active { transform: scale(0.97); }

.user-menu { position: relative; }

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-3);
    border: 2px solid var(--border);
    cursor: pointer;
    background-size: cover;
    background-position: center;
    transition: var(--transition);
}

.avatar:hover { border-color: var(--accent); }

.user-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    width: 240px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: var(--transition);
    z-index: 1000;
}

.user-menu.open .user-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
}

.dropdown-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-3);
    background-size: cover;
    background-position: center;
}

.dropdown-info { display: flex; flex-direction: column; }
.dropdown-info #dropdown-name { font-weight: 600; font-size: 14px; }
.dropdown-info #dropdown-email { font-size: 12px; color: var(--text-3); }

.dropdown-divider {
    height: 1px;
    background: var(--border);
    margin: 4px 0;
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 16px;
    background: transparent;
    border: none;
    color: var(--text-2);
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
}

.dropdown-item:hover {
    background: var(--bg-3);
    color: var(--text);
}

.dropdown-item.danger { color: var(--danger); }
.dropdown-item.danger:hover { background: rgba(239, 68, 68, 0.1); }

.main-layout {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.sidebar {
    width: 220px;
    background: var(--bg-1);
    border-right: 1px solid var(--border);
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow-y: auto;
}

.sidebar-section {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.sidebar-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 11px 14px;
    background: transparent;
    border: none;
    border-radius: var(--radius);
    color: var(--text-2);
    font-family: inherit;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
}

.sidebar-item:hover {
    background: var(--bg-2);
    color: var(--text);
}

.sidebar-item.active {
    background: var(--accent-soft);
    color: var(--accent);
}

.sidebar-item i { width: 18px; text-align: center; }

.sidebar-divider {
    height: 1px;
    background: var(--border);
    margin: 16px 0;
}

.sidebar-label {
    padding: 8px 14px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-3);
}

.model-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.model-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 9px 14px;
    font-size: 13px;
}

.model-item .model-name { color: var(--text-2); }
.model-item .model-cost { color: var(--text-3); font-size: 12px; }
.model-item.coming-soon { opacity: 0.5; }

.model-item .model-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: var(--bg-3);
    border-radius: 4px;
    color: var(--text-3);
}

.content {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
}

.view { display: none; }
.view.active { display: block; }

.view-header { margin-bottom: 28px; }
.view-header h1 { font-size: 26px; font-weight: 700; margin-bottom: 4px; }
.view-header p { color: var(--text-2); }

.project-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

.project-card {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
}

.project-card:hover {
    border-color: var(--border-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.project-preview {
    height: 140px;
    background: var(--bg-2);
    position: relative;
    overflow: hidden;
}

.project-preview iframe {
    width: 200%;
    height: 200%;
    transform: scale(0.5);
    transform-origin: top left;
    border: none;
    pointer-events: none;
}

.preview-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-3);
    font-size: 28px;
}

.project-info { padding: 14px 16px; }

.project-title {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.project-title .vis-icon {
    font-size: 11px;
    color: var(--text-3);
}

.project-desc {
    font-size: 13px;
    color: var(--text-2);
    margin-bottom: 12px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.project-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-3);
}

.project-author {
    display: flex;
    align-items: center;
    gap: 6px;
}

.project-author img {
    width: 18px;
    height: 18px;
    border-radius: 50%;
}

.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 80px 20px;
}

.empty-state i {
    font-size: 48px;
    color: var(--text-3);
    margin-bottom: 16px;
}

.empty-state h3 {
    font-size: 18px;
    margin-bottom: 8px;
}

.empty-state p {
    color: var(--text-2);
    margin-bottom: 24px;
}

#editor-view { padding: 0; }
#editor-view.active { display: flex; }

.editor-layout {
    display: flex;
    width: 100%;
    height: 100%;
}

.editor-sidebar {
    width: 220px;
    background: var(--bg-1);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}

.editor-sidebar-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    border-bottom: 1px solid var(--border);
}

.project-name {
    flex: 1;
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.btn-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: var(--radius);
    color: var(--text-2);
    cursor: pointer;
    transition: var(--transition);
}

.btn-icon:hover {
    background: var(--bg-2);
    color: var(--text);
}

.btn-icon-sm {
    width: 26px;
    height: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: var(--text-3);
    cursor: pointer;
    font-size: 12px;
    transition: var(--transition);
}

.btn-icon-sm:hover {
    background: var(--bg-3);
    color: var(--text);
}

.file-tree {
    flex: 1;
    overflow-y: auto;
    border-bottom: 1px solid var(--border);
}

.file-tree-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-3);
}

.file-list { padding: 0 8px 12px; }

.file-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-2);
}

.file-item:hover {
    background: var(--bg-2);
    color: var(--text);
}

.file-item.active {
    background: var(--accent-soft);
    color: var(--accent);
}

.file-item i { font-size: 12px; width: 14px; text-align: center; }

.file-item .fname {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-item .del-file {
    opacity: 0;
    background: transparent;
    border: none;
    color: var(--text-3);
    cursor: pointer;
    padding: 2px;
    font-size: 10px;
    transition: var(--transition);
}

.file-item:hover .del-file { opacity: 1; }
.file-item .del-file:hover { color: var(--danger); }

.version-section { max-height: 180px; overflow-y: auto; }

.version-header {
    padding: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-3);
}

.version-list { padding: 0 8px 12px; }

.version-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-2);
}

.version-item:hover { background: var(--bg-2); }
.version-item .v-num { font-weight: 600; }
.version-item .v-time { color: var(--text-3); font-size: 11px; }

.editor-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.editor-tabs {
    display: flex;
    background: var(--bg-1);
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    flex-shrink: 0;
}

.editor-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-2);
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
}

.editor-tab:hover { color: var(--text); background: var(--bg-2); }
.editor-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.editor-content {
    flex: 1;
    display: flex;
    overflow: hidden;
}

.code-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

#code-textarea {
    flex: 1;
    width: 100%;
    padding: 16px;
    background: var(--bg-0);
    border: none;
    color: var(--text);
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.6;
    resize: none;
    outline: none;
    tab-size: 2;
}

#code-textarea::placeholder { color: var(--text-3); }

.preview-panel {
    width: 50%;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    background: var(--bg-1);
}

.preview-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-3);
}

#preview-frame {
    flex: 1;
    width: 100%;
    border: none;
    background: #fff;
}

.prompt-bar {
    display: flex;
    align-items: flex-end;
    gap: 12px;
    padding: 14px 16px;
    background: var(--bg-1);
    border-top: 1px solid var(--border);
}

.model-select { position: relative; }

.model-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 11px 14px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
}

.model-btn:hover { border-color: var(--border-light); }
.model-btn i { font-size: 10px; transition: transform var(--transition); }
.model-select.open .model-btn i { transform: rotate(180deg); }

.model-dropdown {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 0;
    width: 260px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    padding: 6px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: var(--transition);
    z-index: 100;
}

.model-select.open .model-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.model-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 10px 12px;
    background: transparent;
    border: none;
    border-radius: var(--radius);
    color: var(--text);
    font-family: inherit;
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
}

.model-option:hover:not(.disabled) { background: var(--bg-3); }
.model-option.selected { background: var(--accent-soft); }
.model-option.disabled { opacity: 0.5; cursor: not-allowed; }

.model-info { display: flex; flex-direction: column; gap: 2px; }
.model-info .name { font-size: 14px; font-weight: 500; }
.model-info .desc { font-size: 11px; color: var(--text-3); }
.model-option .cost { font-size: 12px; color: var(--text-2); }

.model-option .badge {
    font-size: 10px;
    padding: 3px 8px;
    background: var(--bg-4);
    border-radius: 4px;
    color: var(--text-3);
}

.prompt-input-wrap { flex: 1; }

#prompt-input {
    width: 100%;
    padding: 11px 14px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    resize: none;
    outline: none;
    max-height: 100px;
    transition: var(--transition);
}

#prompt-input:focus { border-color: var(--accent); }
#prompt-input::placeholder { color: var(--text-3); }

.btn-generate {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    border: none;
    border-radius: var(--radius);
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
}

.btn-generate:hover:not(:disabled) {
    background: var(--accent-hover);
    transform: scale(1.05);
}

.btn-generate:disabled { opacity: 0.4; cursor: not-allowed; }

.right-panel {
    width: 280px;
    background: var(--bg-1);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}

.panel-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
}

.panel-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-2);
    font-family: inherit;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
}

.panel-tab:hover { color: var(--text); }
.panel-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.panel-body { flex: 1; overflow: hidden; }
.panel { display: none; height: 100%; flex-direction: column; }
.panel.active { display: flex; }

.comments-list {
    flex: 1;
    overflow-y: auto;
    padding: 14px;
}

.comment { margin-bottom: 14px; }

.comment-head {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.comment-avatar {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--bg-3);
    background-size: cover;
}

.comment-author { font-size: 13px; font-weight: 600; }
.comment-time { font-size: 11px; color: var(--text-3); }
.comment-text { font-size: 13px; color: var(--text-2); line-height: 1.5; }

.comment-form {
    padding: 12px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
}

.comment-form textarea {
    flex: 1;
    padding: 10px 12px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: inherit;
    font-size: 13px;
    resize: none;
    outline: none;
}

.comment-form textarea:focus { border-color: var(--accent); }

.btn-sm {
    padding: 10px 14px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
}

.btn-sm:hover { background: var(--accent-hover); }

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 14px;
}

.chat-msg { margin-bottom: 14px; }
.chat-msg.ai { padding-left: 10px; border-left: 2px solid var(--accent); }
.chat-msg-text { font-size: 13px; line-height: 1.6; color: var(--text-2); }

.modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
}

.modal.open { display: flex; }

.modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
}

.modal-box {
    position: relative;
    width: 100%;
    max-width: 480px;
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow);
    animation: modalIn 0.2s ease;
}

.modal-box.modal-sm { max-width: 360px; }

@keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(-16px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    border-bottom: 1px solid var(--border);
}

.modal-header h2 { font-size: 17px; font-weight: 600; }

.modal-close {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--text-3);
    cursor: pointer;
    transition: var(--transition);
}

.modal-close:hover { background: var(--bg-2); color: var(--text); }

.modal-body { padding: 20px; }
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 14px 20px;
    border-top: 1px solid var(--border);
}

.field { margin-bottom: 18px; }
.field:last-child { margin-bottom: 0; }

.field label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-2);
}

.field input,
.field textarea,
.field select {
    width: 100%;
    padding: 11px 14px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: var(--transition);
}

.field input:focus,
.field textarea:focus,
.field select:focus {
    border-color: var(--accent);
}

.field textarea { min-height: 80px; resize: vertical; }
.field small { display: block; margin-top: 6px; font-size: 12px; color: var(--text-3); }

.input-with-prefix {
    display: flex;
    align-items: center;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}

.input-with-prefix .prefix {
    padding: 11px 12px;
    color: var(--text-3);
    font-size: 14px;
    background: var(--bg-3);
    border-right: 1px solid var(--border);
}

.input-with-prefix input {
    border: none;
    border-radius: 0;
    background: transparent;
}

.visibility-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.visibility-card { cursor: pointer; }
.visibility-card input { display: none; }

.visibility-card .card-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 14px 10px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    transition: var(--transition);
}

.visibility-card input:checked + .card-content {
    border-color: var(--accent);
    background: var(--accent-soft);
}

.visibility-card .card-content i {
    font-size: 18px;
    color: var(--text-3);
}

.visibility-card input:checked + .card-content i {
    color: var(--accent);
}

.visibility-card .title {
    font-size: 13px;
    font-weight: 600;
}

.visibility-card .desc {
    font-size: 11px;
    color: var(--text-3);
}

.settings-group { margin-bottom: 24px; }
.settings-group h3 {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 14px;
    color: var(--text-2);
}

.info-list {
    background: var(--bg-2);
    border-radius: var(--radius);
    overflow: hidden;
}

.info-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
}

.info-item:last-child { border-bottom: none; }
.info-item .label { color: var(--text-3); }

.danger-zone {
    padding-top: 18px;
    border-top: 1px solid var(--border);
}

.btn-primary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 11px 20px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:active { transform: scale(0.98); }

.btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 11px 20px;
    background: var(--bg-2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
}

.btn-secondary:hover { background: var(--bg-3); border-color: var(--border-light); }

.btn-danger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 11px 20px;
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
}

.btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

#toast-container {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 3000;
}

.toast {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 18px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    font-size: 14px;
    animation: toastIn 0.25s ease;
}

.toast.success { border-color: var(--accent); }
.toast.success i { color: var(--accent); }
.toast.error { border-color: var(--danger); }
.toast.error i { color: var(--danger); }

.toast.removing { animation: toastOut 0.25s ease forwards; }

@keyframes toastIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes toastOut {
    to { opacity: 0; transform: translateY(-16px); }
}

.loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 3000;
}

.loading-overlay.active { display: flex; }

.loading-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

.loading-spinner {
    width: 44px;
    height: 44px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

@media (max-width: 1100px) {
    .right-panel { display: none; }
}

@media (max-width: 900px) {
    .sidebar { display: none; }
    .nav-search { display: none; }
    .preview-panel { display: none; }
}

@media (max-width: 600px) {
    .navbar { padding: 0 16px; }
    .btn-create span { display: none; }
    .btn-create { padding: 10px 12px; }
    .content { padding: 20px 16px; }
    .project-grid { grid-template-columns: 1fr; }
    .auth-card { padding: 32px 24px; }
    .visibility-grid { grid-template-columns: 1fr; }
}

/* app.js */
const firebaseConfig = {
    apiKey: 'AIzaSyBMzTNiBfT5JOMaJvrCUoK3nKsnSP_aJxg',
    authDomain: 'droidgenai.firebaseapp.com',
    projectId: 'droidgenai',
    storageBucket: 'droidgenai.firebasestorage.app',
    messagingSenderId: '919385381226',
    appId: '1:919385381226:web:172d54c8ab332c2690ad13',
    measurementId: 'G-SMWBPGEJJK'
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const googleProvider = new firebase.auth.GoogleAuthProvider();

const state = {
    user: null,
    credits: 0,
    username: '',
    projects: [],
    selectedModel: { id: 'xiaomi/mimo-v2-flash:free', name: 'MiMo 2 Flash', cost: 300 },
    isGenerating: false,
    initDone: false
};

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

const elements = {
    authScreen: $('#auth-screen'),
    mainScreen: $('#main-screen'),
    googleLogin: $('#google-login'),
    creditsCount: $('#credits-count'),
    userAvatar: $('#user-avatar'),
    userName: $('#dropdown-name'),
    userEmail: $('#dropdown-email'),
    logoutBtn: $('#logout-btn'),
    promptInput: $('#prompt-input'),
    generateBtn: $('#generate-btn'),
    loadingOverlay: $('#loading-overlay')
};

auth.onAuthStateChanged(async (user) => {
    if (user) {
        if (!state.initDone) await initUser(user);
    } else {
        state.user = null;
        state.initDone = false;
        switchScreen(elements.authScreen);
    }
});

elements.googleLogin.addEventListener('click', async () => {
    try {
        elements.googleLogin.disabled = true;
        const result = await auth.signInWithPopup(googleProvider);
        if (result.user) {
            await initUser(result.user);
        }
    } catch (error) {
        showToast(error.message, 'error');
        elements.googleLogin.disabled = false;
    }
});

elements.logoutBtn.addEventListener('click', () => auth.signOut());

async function initUser(user) {
    try {
        const res = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'init_user',
                userId: user.uid,
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL
            })
        });
        
        const data = await res.json();
        if (data.success) {
            state.user = user;
            state.credits = data.credits;
            state.username = data.username;
            state.projects = data.projects;
            state.initDone = true;
            updateUI();
            switchScreen(elements.mainScreen);
        } else {
            throw new Error(data.error || 'Init failed');
        }
    } catch (error) {
        console.error('Init error:', error);
        showToast('Connection failed. Retrying...', 'error');
        setTimeout(() => { if(auth.currentUser) initUser(auth.currentUser); }, 3000);
    }
}

function updateUI() {
    elements.creditsCount.textContent = state.credits.toLocaleString();
    if (state.user?.photoURL) {
        elements.userAvatar.style.backgroundImage = `url(${state.user.photoURL})`;
        $('.dropdown-avatar').style.backgroundImage = `url(${state.user.photoURL})`;
    }
    elements.userName.textContent = state.user?.displayName || state.username;
    elements.userEmail.textContent = state.user?.email || '';
}

function switchScreen(screen) {
    $$('.screen').forEach(s => s.classList.remove('active'));
    screen.classList.add('active');
}

function showToast(msg, type = 'success') {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}"></i><span>${msg}</span>`;
    $('#toast-container').appendChild(t);
    setTimeout(() => {
        t.classList.add('removing');
        setTimeout(() => t.remove(), 300);
    }, 3000);
}

elements.userAvatar.addEventListener('click', (e) => {
    e.stopPropagation();
    $('#user-menu').classList.toggle('open');
});

document.addEventListener('click', () => $('#user-menu').classList.remove('open'));

/* api/generate.js */
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
    process.env.SUPABASE_URL || '',
    process.env.SUPABASE_SERVICE_KEY || ''
);

const OPENROUTER_KEY = process.env.OPENROUTER_API_KEY;
const ADMIN_EMAIL = process.env.ADMIN_EMAIL_ONE;
const DEMO_CREDITS = 100000;

const MODEL_COSTS = {
    'xiaomi/mimo-v2-flash:free': 300,
    'mistralai/devstral-2512:free': 100,
    'z-ai/glm-4.5-air:free': 100,
    'openai/gpt-oss-120b:free': 50
};

const rateMap = new Map();
const reqMap = new Map();

function rateOk(uid) {
    const now = Date.now();
    const last = rateMap.get(uid);
    if (last && now - last < 3000) return false;
    rateMap.set(uid, now);
    return true;
}

function ddosOk(ip) {
    const now = Date.now();
    let reqs = reqMap.get(ip) || [];
    reqs = reqs.filter(t => now - t < 60000);
    reqs.push(now);
    reqMap.set(ip, reqs);
    return reqs.length <= 60;
}

export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    if (req.method === 'OPTIONS') return res.status(200).end();
    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
    
    const ip = req.headers['x-forwarded-for'] || 'unknown';
    if (!ddosOk(ip)) return res.status(429).json({ error: 'Too many requests' });
    
    try {
        const { action, userId, email, displayName, photoURL, username, prompt, model, cost, files, projects, projectName } = req.body;
        
        if (action === 'init_user') {
            if (!userId || !email) return res.status(400).json({ error: 'Missing data' });
            
            let { data: user, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();
            
            if (!user) {
                const { data: newUser, error: createError } = await supabase
                    .from('users')
                    .insert({
                        id: userId,
                        email: email,
                        display_name: displayName,
                        photo_url: photoURL,
                        username: email.split('@')[0] + Math.floor(Math.random() * 1000),
                        credits: DEMO_CREDITS
                    })
                    .select()
                    .single();
                user = newUser;
            }

            const { data: userProjects } = await supabase
                .from('projects')
                .select('*')
                .eq('author_id', userId);

            return res.json({
                success: true,
                credits: user.credits,
                username: user.username,
                projects: userProjects || []
            });
        }
        
        if (action === 'save_projects') {
            if (!userId || !projects) return res.status(400).json({ error: 'Missing data' });
            
            for (const p of projects) {
                await supabase.from('projects').upsert({
                    id: p.id,
                    name: p.name,
                    description: p.description,
                    visibility: p.visibility,
                    slug: p.slug,
                    files: p.files,
                    versions: p.versions,
                    comments: p.comments,
                    preview: p.preview?.substring(0, 100000),
                    author_id: userId,
                    author_username: p.authorUsername,
                    author_photo: p.authorPhoto,
                    created_at: p.createdAt,
                    updated_at: p.updatedAt
                }, { onConflict: 'id' });
            }
            
            return res.json({ success: true });
        }
        
        if (action === 'update_username') {
            if (!userId || !username) return res.status(400).json({ error: 'Missing data' });
            
            const clean = username.toLowerCase().replace(/[^a-z0-9_]/g, '').substring(0, 20);
            
            const { data: taken } = await supabase
                .from('users')
                .select('id')
                .eq('username', clean)
                .neq('id', userId)
                .single();
            
            if (taken) return res.status(400).json({ error: 'Username taken' });
            
            await supabase.from('users').update({ username: clean }).eq('id', userId);
            
            return res.json({ success: true, username: clean });
        }
        
        if (action === 'generate') {
            if (!userId || !prompt || !model) return res.status(400).json({ error: 'Missing data' });
            if (!rateOk(userId)) return res.status(429).json({ error: 'Wait before generating again' });
            
            const actualCost = MODEL_COSTS[model];
            if (!actualCost) return res.status(400).json({ error: 'Invalid model' });
            
            const { data: user } = await supabase
                .from('users')
                .select('credits, is_generating')
                .eq('id', userId)
                .single();
            
            if (!user) return res.status(404).json({ error: 'User not found' });
            if (user.is_generating) return res.status(429).json({ error: 'Generation in progress' });
            if (user.credits < actualCost) return res.status(400).json({ error: 'Not enough credits' });
            
            await supabase.from('users').update({ is_generating: true }).eq('id', userId);
            
            try {
                const filesCtx = files?.map(f => `--- ${f.name} ---\n${f.content}`).join('\n\n') || '';
                
                const sysPrompt = `You are DroidGen, an expert code generator. You ONLY output code.

Rules:
- Output code in markdown blocks with filename comment
- Format: \`\`\`html\n// index.html\n<code>\n\`\`\`
- Make complete, working code
- Use modern best practices
- No explanations, only code blocks`;

                const userPrompt = filesCtx 
                    ? `Current files:\n\n${filesCtx}\n\nRequest: ${prompt.substring(0, 5000)}`
                    : `Create: ${prompt.substring(0, 5000)}`;
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://droidgen.vercel.app',
                        'X-Title': 'DroidGen'
                    },
                    body: JSON.stringify({
                        model,
                        messages: [
                            { role: 'system', content: sysPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        max_tokens: 8000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API error');
                }
                
                const data = await response.json();
                const output = data.choices[0]?.message?.content || '';
                const parsed = parseBlocks(output);
                
                const newCredits = user.credits - actualCost;
                await supabase.from('users').update({ credits: newCredits, is_generating: false }).eq('id', userId);
                
                return res.json({ success: true, output, files: parsed, credits: newCredits });
                
            } catch (e) {
                await supabase.from('users').update({ is_generating: false }).eq('id', userId);
                throw e;
            }
        }
        
        if (action === 'admin_give_credits') {
            const { adminId, targetEmail, credits: amt } = req.body;
            
            const { data: admin } = await supabase.from('users').select('email').eq('id', adminId).single();
            if (!admin || admin.email !== ADMIN_EMAIL) return res.status(403).json({ error: 'Unauthorized' });
            
            const { data: target } = await supabase.from('users').select('id, credits').eq('email', targetEmail).single();
            if (!target) return res.status(404).json({ error: 'User not found' });
            
            await supabase.from('users').update({ credits: target.credits + amt }).eq('id', target.id);
            
            return res.json({ success: true });
        }
        
        return res.status(400).json({ error: 'Unknown action' });
        
    } catch (e) {
        console.error(e);
        return res.status(500).json({ error: e.message || 'Server error' });
    }
}

function parseBlocks(output) {
    const files = [];
    const regex = /```(\w+)?\n([\s\S]*?)```/g;
    let match;
    while ((match = regex.exec(output)) !== null) {
        files.push({
            lang: match[1] || 'txt',
            content: match[2].trim()
        });
    }
    return files;
}
